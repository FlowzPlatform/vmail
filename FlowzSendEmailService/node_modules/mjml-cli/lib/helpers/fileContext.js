'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _mjmlCore = require('mjml-core');

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var ensureMJMLFile = function ensureMJMLFile(file) {
  return file.trim().match(/.mjml/) && file || file + '.mjml';
};
var error = function error(e) {
  return console.log(e.stack || e);
}; // eslint-disable-line no-console

exports.default = function (baseFile) {
  var filesIncluded = [_path2.default.resolve(baseFile)];

  var readIncludes = function readIncludes(dir, file, base) {
    var currentFile = _path2.default.resolve(_path2.default.join(dir, ensureMJMLFile(file)));
    var currentDirectory = _path2.default.dirname(currentFile);
    var includeRegexp = new RegExp(_mjmlCore.mjIncludeRegexp);

    var content = void 0;
    try {
      content = _fs2.default.readFileSync(currentFile, 'utf8');
    } catch (e) {
      error('File not found ' + currentFile + ' from ' + base);
      return;
    }

    var matchgroup = includeRegexp.exec(content);
    while (matchgroup != null) {
      var includedFile = ensureMJMLFile(matchgroup[1]);
      var includedFilePath = _path2.default.resolve(_path2.default.join(currentDirectory, includedFile));

      filesIncluded.push(includedFilePath);

      readIncludes(_path2.default.dirname(currentFile), includedFile, currentFile);
      matchgroup = includeRegexp.exec(content);
    }
  };

  readIncludes('.', baseFile, baseFile);

  return filesIncluded;
};

module.exports = exports['default'];